<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ This Source Code Form is subject to the terms of the Mozilla Public License,
  ~ v. 2.0. If a copy of the MPL was not distributed with this file, You can
  ~ obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under
  ~ the terms of the Healthcare Disclaimer located at http://openmrs.org/license.
  ~ <p>
  ~ Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS
  ~ graphic logo is a trademark of OpenMRS Inc.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet id="cfl-20190808-11:50" author="Connect for Life">
        <validCheckSum>3:92f2a33288b19d05ef5b0f9c95e2820e</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "bfdf8ed0-87e3-437e-897d-81434393a233";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the Location personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">LocationAttribute</column>
            <column name="description">Attribute used to store information about patient localization</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">bfdf8ed0-87e3-437e-897d-81434393a233</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190826-11:50" author="Connect for Life">
        <validCheckSum>3:56aa7fb61fda8499fb2bedb38b0ce2c5</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type"/>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "58cb9e76-75a1-4f49-956f-4ff6d0e02312";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the email personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">EmailAttribute</column>
            <column name="description">Attribute used to store information about patient email</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">58cb9e76-75a1-4f49-956f-4ff6d0e02312</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200624-13:00" author="Connect for Life">
        <validCheckSum>3:c697741d4fe8950794bdd3adac42814f</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="relationship_type"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM relationship_type WHERE uuid = 'acec590b-825e-45d2-876a-0028f174903d';
            </sqlCheck>
        </preConditions>

        <comment>Retired all unnecessary relationship types</comment>

        <update tableName="relationship_type">
            <column name="retired" value="1"/>
            <where>uuid != 'acec590b-825e-45d2-876a-0028f174903d'</where>
        </update>
    </changeSet>

    <changeSet id="cfl-2021-02-19-16:22-clean-autogenerated-true-false-concepts" author="Connect for Life">
        <validCheckSum>3:34e72c552ba861c536ded34f3533fab6</validCheckSum>
        <comment>Delete all auto-generated Concepts Yes/No Concept Names for True/False Concept.
            These Yes/No Concepts are reliably generated with IDs 1 and 2 and random UUID.
            The random UUID prevents them from being useful, referenced from Concept packages.</comment>
        <delete tableName="concept_name">
            <where>concept_id = 1 and name = 'Sim' and locale = 'pt'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 1 and name = 'Yes' and locale = 'en' and uuid != '1136BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 1 and name = 'Sì' and locale = 'it' and uuid != '126316BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 1 and name = 'Oui' and locale = 'fr' and uuid = '1137BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 1 and name = 'Sí' and locale = 'es' and uuid != '108333BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 2 and name = 'Não' and locale = 'pt' and uuid != '126361BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 2 and name = 'No' and locale = 'en' and uuid != '1138BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 2 and name = 'No' and locale = 'it' and uuid != '126359BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 2 and name = 'Non' and locale = 'fr' and uuid != '1139BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
        <delete tableName="concept_name">
            <where>concept_id = 2 and name = 'No' and locale = 'es' and uuid != '108334BBBBBBBBBBBBBBBBBBBBBBBBBBBBBB'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20210311-16:19-Fix-FSN" author="Connect for Life">
        <validCheckSum>3:1b558f987cfaa57fcf315b442c7bc649</validCheckSum>
        <comment>
            Fix Risk factor for HIV Concepts. Makes Concept Names with 'en-GB' locale (if any exist)
            a Fully Specified Names for Concepts which have no Fully Specified Name defined.
        </comment>
        <sql><![CDATA[
            update
                concept_name as cn_en
            inner
                join concept as c
                    on c.concept_id = cn_en.concept_id
            left join
                concept_name as cn_fsn
                    on cn_fsn.concept_id = c.concept_id and cn_fsn.concept_name_type = 'FULLY_SPECIFIED'
            set cn_en.concept_name_type = 'FULLY_SPECIFIED'
            where
                cn_en.concept_name_type is null
                and cn_en.locale = 'en-GB'
                and cn_fsn.concept_name_id is null
        ]]></sql>
    </changeSet>

    <changeSet id="cfldistribution-change-LocationAttribute-uuid" author="Connect for Life">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from person_attribute_type
                where uuid = '0a93cbc6-5d65-4886-8091-47a25d3df944'
            </sqlCheck>
            <sqlCheck expectedResult="0">
                select count(*)
                from global_property
                where property = 'locationbasedaccess.locationAttributeUuid' and property_value = '0a93cbc6-5d65-4886-8091-47a25d3df944'
            </sqlCheck>
        </preConditions>
        <comment>
            Changed LocationAttribute UUID to be compatible with openmrs-module-locationbasedaccess:0.2.0.
        </comment>
        <update tableName="person_attribute_type">
            <column name="uuid" value="0a93cbc6-5d65-4886-8091-47a25d3df944" />
            <where>name = 'LocationAttribute' and retired = 0</where>
        </update>
        <update tableName="global_property">
            <column name="property_value" value="0a93cbc6-5d65-4886-8091-47a25d3df944" />
            <where>property = 'locationbasedaccess.locationAttributeUuid'</where>
        </update>
    </changeSet>
</databaseChangeLog>
